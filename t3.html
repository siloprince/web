<!doctype html> 
<html>
    <head>
    <meta name="viewport" content="width=350" />
    <meta charset="utf-8" />
    <script>
window.addEventListener('load',function() {
  let scale = 4;
  let sqrt3 = 1.7320508;
  let width = Math.floor(32*scale*sqrt3);
  let height = Math.floor(12*scale*3);

  document.body.insertAdjacentHTML('beforeend','<br/><input type="file" accept="image/*"/><br/>');
  document.body.insertAdjacentHTML('beforeend','<canvas></canvas></br>');
  document.body.insertAdjacentHTML('beforeend','<div class="draw"></div></br>');
  document.body.insertAdjacentHTML('beforeend','<div class="mail" style="font-size:20px;"></div>');

  document.querySelector('input').addEventListener('change',  drawImage);

  let canvas = document.querySelector('canvas');

  let array = [];
  let svg = [];
  const rgba = 4;
  function run (e) {
    svg.push(`<svg width="240" height="180">`);
    svg.push(`<g transform="translate(10,10)">`);
    svg.push(`<g transform="scale(${scale},${scale})">`);
    let canvas = document.querySelector('canvas');
    let image = canvas.getContext('2d').getImageData(0,0,canvas.width, canvas.height);
    let data = image.data;
    for (let y=0;y<12;y++) {
      for (let x=0;x<32;x++) {    
        let c = center(x,y);
        let xx = Math.floor(c[0] * scale);
        let yy = Math.floor(c[1] * scale);
        let sum = calc(data,xx,yy);
        if (sum>255*0.7) {
          white(x,y);
        } else {
          black(x,y);
        }
      }
    }
    svg.push('</g>');
    drawGrid();
    svg.push('</g></svg>');
    document.querySelector('div.draw').innerHTML = svg.join('');
    console.log(array.join(''));
    document.querySelector('div.mail').innerHTML = `<a href='mailto:info@tessellation.jp?subject=t3puzzle&amp;body=`+array.join('').replace(/\n/g,'&#010;')+`'>mail</a>`;
    svg.length=0;
    array.length=0;
  }
  function calc (data,xx,yy) {
    let loc = (yy * width + xx)* rgba;
    let sum = data[loc+0]+data[loc+1]+data[loc+2];
    return sum;
  }
  function white(x,y) {
    if (x===0) {
      array.push('\n');
    }
    array.push('0');
    triangle(x,y,'white');
  }
  function black(x,y) {
    let parity = x%2;
    if (x===0) {
      array.push('\n');
    }
    array.push('1');
    triangle(x,y,'green');
  }
  function center(x,y) {
    let cx = x*sqrt3;
    let cy = 0;
    if (y%2===0){
      if (x%2===0) {
        cy = 2+(y/2)*6;
      } else {
        cy = 1+(y/2)*6;
      }
    } else {
      if (x%2===0) {
        cy = 3+1+((y-1)/2)*6;
      } else {
        cy = 3+2+((y-1)/2)*6;
      }
    }
    return [cx,cy];
  }
  function triangle(x,y,color) {
    let c = center(x,y);
    let rot = 0;
    if ((x+y)%2===0){
      rot = 180;
    }
    if ((x+y <6)||(x+y>37)||(y-x>5)||(x-y>26)) {
        return;
    }
    svg.push(`<g transform="translate(${c[0]},${c[1]})rotate(${rot})">`);
    svg.push(`<polygon points="-1.7320508,-1 1.7320508,-1 0,2" style="fill:${color};"></polygon>`);
    svg.push('</g>');
  }
  function moveTo (x,y) {
      svg.push(`M${x},${y} `);
  }
  function lineTo (x,y) {
      svg.push(`L${x},${y} `);
  }
  function beginPath() {
      svg.push('<path d="');
  }
  function stroke() {
      svg.push('" style="fill:none;stroke:#555555;stroke-width:3;"></path>');
  }
  function drawGrid () {
    beginPath();
    for (let y=0;y<=6;y++) {
        let x0 = 0;
        let y0 = y*height/6;
        let x1 = 0;
        let y1 = y0;
        if (y<3) {
          x0 += (3-y)*width/16;
          x1 += (16-3+y)*width/16;
          moveTo(x0,y0);
          lineTo(x1,y1);
        } else {
          x0 += (y-3)*width/16;
          x1 += (16+3-y)*width/16;
          moveTo(x0,y0);
          lineTo(x1,y1);
        }
    }
    for (let x=0;x<=8;x++) {
        let x0 = 0;
        let y0 = 3*height/6;
        let x1 = 0;
        if (x<5) {
          let y1 = 0*height/6;
          let y2 = 6*height/6;
          x0 += (x*2)*width/16;
          x1 += (x*2+3)*width/16;
          moveTo(x1,y1);
          lineTo(x0,y0);
          lineTo(x1,y2);
        } else {
          let y1 = (0-5+x)*height/6;
          let y2 = (6+5-x)*height/6;
          x0 += (x*2)*width/16;
          x1 += (x*2+3+(5-x))*width/16;
          moveTo(x1,y1);
          lineTo(x0,y0);
          lineTo(x1,y2);
        }
    }
    for (let x=0;x<=8;x++) {
        let x0 = 0;
        let y0 = 3*height/6;
        let x1 = 0;
        if (x>=3) {
          let y1 = 0*height/6;
          let y2 = 6*height/6;
          x0 += (x*2)*width/16;
          x1 += (x*2-3)*width/16;
          moveTo(x1,y1);
          lineTo(x0,y0);
          lineTo(x1,y2);
        } else {
          let y1 = (3-x)*height/6;
          let y2 = (3+x)*height/6;
          x0 += (x*2)*width/16;
          x1 += (x*2-3+(3-x))*width/16;
          moveTo(x1,y1);
          lineTo(x0,y0);
          lineTo(x1,y2);
        }
    }
    stroke();
  }
  function drawImage (e) {
    let image = new Image();
    image.addEventListener('load', function() {
      let canvas = document.querySelector('canvas');
      canvas.setAttribute('width',width);
      canvas.setAttribute('height',height);
      canvas.getContext('2d').drawImage(this, 0, 0, width, height);
      run();
    });
    let reader = new FileReader();
    reader.addEventListener('load',function(e) {
      image.src = e.target.result;
    });
    reader.readAsDataURL(e.target.files[0]);
  }
});
    </script>
    </head>
    <body></body>
</html>


