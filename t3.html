<!doctype html> 
<html>
    <head>
    <meta name="viewport" content="width=350" />
    <meta charset="utf-8" />
    <script>
window.addEventListener('load',function() {
  let svgScale = 4;
  let canvasScale = 20;
  let sqrt3 = 1.7320508;
  let svgWidth = Math.round(32*svgScale*sqrt3);
  let svgHeight = Math.round(12*svgScale*3);
  let canvasWidth = Math.round(32*canvasScale*sqrt3);
  let canvasHeight = Math.round(12*canvasScale*3);

  document.body.insertAdjacentHTML('beforeend','<br/><input type="file" accept="image/*"/><br/>');
  document.body.insertAdjacentHTML('beforeend','<canvas class="disp"></canvas></br>');
  document.body.insertAdjacentHTML('beforeend','<div class="draw"></div></br>');
  document.body.insertAdjacentHTML('beforeend','<div class="mail" style="font-size:20px;"></div>');
  //document.body.insertAdjacentHTML('beforeend','<canvas class="hidden"></canvas></br>');

  document.querySelector('input').addEventListener('change',  drawImage);

  let disp = document.querySelector('canvas.disp');

  let array = [];
  let svg = [];
  const rgba = 4;
  function run (e) {
    svg.push(`<svg width="240" height="180">`);
    svg.push(`<g transform="translate(10,10)">`);
    svg.push(`<g transform="scale(${svgScale},${svgScale})">`);
    let disp = document.querySelector('canvas.disp');
    let image = disp.getContext('2d').getImageData(0,0,disp.width, disp.height);
    let data = image.data;
    let peak = [];
    let range = 10;
    for (let i=0;i<255/range;i++) {
      peak.push({ count:0, index: i});
    }
    for (let y=0;y<12;y++) {
      for (let x=0;x<32;x++) {  
        if (outside(x,y)) {
          continue;
        }  
        let val = calc(data,x,y,canvasWidth,canvasHeight);
        let zone = Math.floor(val/range);
        peak[zone].count+=1;
      }
    }
    peak.sort(function(a,b){
        if( a.count > b.count ) return -1;
        if( a.count < b.count ) return 1;
        return 0;
    });
    let firstPeakIndex=peak[0].index;
    if (Math.abs(peak[0].index - peak[1].index)!==1) {
      secondPeakIndex=peak[1].index;
    } else {
      if ((Math.abs(peak[1].index - peak[2].index)!==1)&&(Math.abs(peak[0].index - peak[2].index)!==1)) {
        secondPeakIndex=peak[2].index;
      } else {
        secondPeakIndex=peak[3].index;
      }
    }
    if (firstPeakIndex>secondPeakIndex) {
      let tmpIndex = firstPeakIndex;
      firstPeakIndex = secondPeakIndex;
      secondPeakIndex = tmpIndex;
    }
    console.log('1:'+firstPeakIndex+' 2:'+secondPeakIndex);
    for (let y=0;y<12;y++) {
      for (let x=0;x<32;x++) {  
        if (outside(x,y)) {
          continue;
        }
        let val = calc(data,x,y,canvasWidth,canvasHeight,[firstPeakIndex*range+range/2,secondPeakIndex*range+range/2]);
        if (val===0) {
          white(x,y);
        } else {
          black(x,y);
        }
      }
    }
    svg.push('</g>');
    drawGrid(svgWidth,svgHeight);
    svg.push('</g></svg>');
    document.querySelector('div.draw').innerHTML = svg.join('');
    console.log(array.join(''));
    document.querySelector('div.mail').innerHTML = `<a href='mailto:info@tessellation.jp?subject=t3puzzle&amp;body=`+array.join('')+`'>mail</a>`;
    svg.length=0;
    array.length=0;
  }
  function calc (data,x,y,width,height,peaks) {
    let c = center(x,y);
    let xx = Math.round(c[0] * canvasScale);
    let yy = Math.round(c[1] * canvasScale);      
    let sum=0;
    let mom=0;
    let imax= Math.round(sqrt3 * canvasScale);
    let jmax= Math.round(canvasScale);
    let b=0;
    let w=0;
    let ctx = disp.getContext('2d');
    if ((x+y)%2===0) {
      ctx.fillStyle = "rgb(255, 0, 0)";
      for (let i=-imax;i<=imax;i++) {
        for (let j=-2*jmax;j<=jmax;j++) {
          let xxx = xx+i;
          let yyy = yy+j;
          if (xxx<0 || xxx>=width || yyy<0 || yyy>=height) {
            continue;
          }
          if (y/sqrt3+x < 1 || y/sqrt-x < -1) {
            continue;
          }
          ctx.fillRect(xxx,yyy,1,1);
          let loc = (yyy * width + xxx)* rgba;
          let val = (data[loc+0]+data[loc+1]+data[loc+2])/3;
          sum += val;
          if (peaks) {
            if (Math.abs(peaks[0]-val)>Math.abs(peaks[1]-val)) {
              b++;
            } else {
              w++;
            }
          }
          mom++;
        }
      }
    } else {
      ctx.fillStyle = "rgb(0, 0, 255)";
      for (let i=-imax;i<=imax;i++) {
        for (let j=-jmax;j<=2*jmax;j++) {
          let xxx = xx+i;
          let yyy = yy+j;
          if (xxx<0 || xxx>=width || yyy<0 || yyy>=height) {
            continue;
          }
          if (y/sqrt3-x > 0 || y/sqrt-x >2) {
            continue;
          }
          ctx.fillRect(xxx,yyy,1,1);
          let loc = (yyy * width + xxx)* rgba;
          let val = (data[loc+0]+data[loc+1]+data[loc+2])/3;
          sum += val;
          if (peaks) {
            if (Math.abs(peaks[0]-val)>Math.abs(peaks[1]-val)) {
              b++;
            } else {
              w++;
            }
          }
          mom++;
        }
      }
    }
    if (peaks) {
      if (b>w) {
        return 0;
      } else {
        return 255;
      }
    } else {
      if (mom===0) {
        return 0;
      } else {
        return sum/mom;
      }
    }
  }
  function white(x,y) {
    if (x===0) {
      array.push('\n');
    }
    array.push('0');
    triangle(x,y,'white');
  }
  function black(x,y) {
    let parity = x%2;
    if (x===0) {
      array.push('\n');
    }
    array.push('1');
    triangle(x,y,'green');
  }
  function center(x,y) {
    let cx = x*sqrt3;
    let cy = 0;
    if (y%2===0){
      if (x%2===0) {
        cy = 2+(y/2)*6;
      } else {
        cy = 1+(y/2)*6;
      }
    } else {
      if (x%2===0) {
        cy = 3+1+((y-1)/2)*6;
      } else {
        cy = 3+2+((y-1)/2)*6;
      }
    }
    return [cx,cy];
  }
  function outside(x,y) {
    return((x+y <6)||(x+y>37)||(y-x>5)||(x-y>26));
  }
  function triangle(x,y,color) {
    let c = center(x,y);
    let rot = 0;
    if ((x+y)%2===0){
      rot = 180;
    }
    if (outside(x,y)) {
        return;
    }
    svg.push(`<g transform="translate(${c[0]},${c[1]})rotate(${rot})">`);
    svg.push(`<polygon points="-1.7320508,-1 1.7320508,-1 0,2" style="fill:${color};"></polygon>`);
    svg.push('</g>');
  }
  function moveTo (x,y) {
      svg.push(`M${x},${y} `);
  }
  function lineTo (x,y) {
      svg.push(`L${x},${y} `);
  }
  function beginPath() {
      svg.push('<path d="');
  }
  function stroke() {
      svg.push('" style="fill:none;stroke:#888888;stroke-width:1;stroke-linecap:round;"></path>');
  }
  function drawGrid (width,height) {
    beginPath();
    for (let y=0;y<=6;y++) {
        let x0 = 0;
        let y0 = y*height/6;
        let x1 = 0;
        let y1 = y0;
        if (y<3) {
          x0 += (3-y)*width/16;
          x1 += (16-3+y)*width/16;
          moveTo(x0,y0);
          lineTo(x1,y1);
        } else {
          x0 += (y-3)*width/16;
          x1 += (16+3-y)*width/16;
          moveTo(x0,y0);
          lineTo(x1,y1);
        }
    }
    for (let x=0;x<=8;x++) {
        let x0 = 0;
        let y0 = 3*height/6;
        let x1 = 0;
        if (x<5) {
          let y1 = 0*height/6;
          let y2 = 6*height/6;
          x0 += (x*2)*width/16;
          x1 += (x*2+3)*width/16;
          moveTo(x1,y1);
          lineTo(x0,y0);
          lineTo(x1,y2);
        } else {
          let y1 = (0-5+x)*height/6;
          let y2 = (6+5-x)*height/6;
          x0 += (x*2)*width/16;
          x1 += (x*2+3+(5-x))*width/16;
          moveTo(x1,y1);
          lineTo(x0,y0);
          lineTo(x1,y2);
        }
    }
    for (let x=0;x<=8;x++) {
        let x0 = 0;
        let y0 = 3*height/6;
        let x1 = 0;
        if (x>=3) {
          let y1 = 0*height/6;
          let y2 = 6*height/6;
          x0 += (x*2)*width/16;
          x1 += (x*2-3)*width/16;
          moveTo(x1,y1);
          lineTo(x0,y0);
          lineTo(x1,y2);
        } else {
          let y1 = (3-x)*height/6;
          let y2 = (3+x)*height/6;
          x0 += (x*2)*width/16;
          x1 += (x*2-3+(3-x))*width/16;
          moveTo(x1,y1);
          lineTo(x0,y0);
          lineTo(x1,y2);
        }
    }
    stroke();
  }
  function drawImage (e) {
    let image = new Image();
    image.addEventListener('load', function() {
      let disp = document.querySelector('canvas.disp');
      disp.setAttribute('width',canvasWidth);
      disp.setAttribute('height',canvasHeight);
      disp.getContext('2d').drawImage(this, 0, 0, disp.width, disp.height);
      run();
    });
    let reader = new FileReader();
    reader.addEventListener('load',function(e) {
      image.src = e.target.result;
    });
    reader.readAsDataURL(e.target.files[0]);
  }
});
    </script>
    </head>
    <body></body>
</html>


